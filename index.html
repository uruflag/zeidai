<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>徴収法クイズ</title>
    <style>
        :root { --primary: #3f51b5; --success: #e8f5e9; --error: #ffebee; }
        body { font-family: sans-serif; background: #f5f5f5; margin: 0; padding: 20px; color: #333; line-height: 1.6; }
        .card { background: white; border-radius: 12px; padding: 24px; max-width: 500px; margin: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        
        /* ヘッダー */
        .quiz-header { border-bottom: 1px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
        .category-label { color: #d32f2f; font-weight: bold; font-size: 1.1rem; display: block; margin-top: 4px; }
        .progress-text { font-size: 0.9rem; color: #666; }

        /* 選択肢（画像のデザインに寄せています） */
        .option { border: 1px solid #eee; padding: 16px; margin: 10px 0; border-radius: 8px; cursor: pointer; background: #fafafa; transition: 0.2s; position: relative; }
        .option:hover { background: #f0f0f0; }
        .option.correct { background: var(--success); border-color: #4caf50; color: #1b5e20; }
        .option.correct::before { content: "✓ 正解です！"; display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 4px; }
        .option.wrong { background: var(--error); border-color: #f44336; color: #b71c1c; }
        .disabled { pointer-events: none; }

        /* 解説 */
        .explanation { margin-top: 0; padding: 0 16px 16px 16px; font-size: 0.9rem; color: #444; }
        
        /* ボタン */
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 25px; cursor: pointer; width: 100%; font-size: 1rem; font-weight: bold; }
        .nav-btns { display: flex; gap: 15px; margin-top: 25px; }
        .nav-btns button { flex: 1; background: #4a59bd; }
        
        input, select { width: 100%; padding: 12px; margin: 10px 0 20px 0; border: 1px solid #ccc; border-radius: 6px; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; border: 12px solid #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; margin: 20px auto; border-top-color: #4caf50; }
    </style>
</head>
<body>

<!-- 設定画面 -->
<div id="setup-screen" class="card">
    <h2 style="text-align:center;">クイズ設定</h2>
    <label>カテゴリー選択</label>
    <select id="category-select">
	<option value="quiz_001.tsv">第1章 総　説</option>
    	<option value="quiz_002.tsv">第2章 調　査</option>
    	<option value="quiz_003.tsv">第3章 差押え</option>
    	<option value="quiz_004.tsv">第4章 交付要求</option>
    	<option value="quiz_005.tsv">第5章 換価・配当</option>
    	<option value="quiz_006.tsv">第6章 納税義務の拡張</option>
    	<option value="quiz_008.tsv">第7章 緩和制度</option>
    	<option value="quiz_009.tsv">第8章 保全処分</option>
    	<option value="quiz_010.tsv">第9章 罰　則</option>
    </select>
    <label>出題数</label>
    <input type="number" id="question-count" value="5">
    <p id="error-msg" style="color:red; font-size:0.85rem; margin-bottom:15px;"></p>
    <button class="btn" onclick="loadAndStart()">クイズ開始</button>
</div>

<!-- クイズ画面 -->
<div id="quiz-screen" class="card hidden">
    <div class="quiz-header">
        <div style="display:flex; justify-content:space-between; align-items: baseline;">
            <span style="font-weight:bold; font-size:1.2rem;">徴収法クイズ</span>
            <span id="progress" class="progress-text"></span>
        </div>
        <!-- 10. カテゴリー名をここに表示 -->
        <span id="current-category" class="category-label"></span>
    </div>

    <p id="question-text" style="font-size:1.1rem; font-weight:500; margin-bottom:20px;"></p>
    <div id="options-container"></div>
    <div id="explanation-area" class="hidden explanation"></div>
    
    <div class="nav-btns">
        <button class="btn" onclick="prevQuestion()">前へ</button>
        <button id="next-btn" class="btn" onclick="nextQuestion()">次へ</button>
    </div>
</div>

<!-- 結果画面 -->
<div id="result-screen" class="card hidden">
    <h2 style="text-align:center;">よくできました。<br>クイズ終了。</h2>
    <div id="score-chart" class="score-circle">
        <span id="result-percent">0%</span>
        <span style="font-size:0.8rem; color:#666;" id="result-ratio">0/0</span>
    </div>
    <p id="feedback-msg" style="text-align:center; font-weight:bold; font-size:1.1rem; margin:20px 0;"></p>
    <button class="btn" onclick="location.reload()">もう一度クイズを受ける</button>
</div>

<script>
let quizData = [];
let currentIdx = 0;
let userAnswers = [];
let categoryName = "";

async function loadAndStart() {
    const fileName = document.getElementById('category-select').value;
    const inputCount = parseInt(document.getElementById('question-count').value);
    
    try {
        const response = await fetch(fileName);
        if (!response.ok) throw new Error();
        const text = await response.text();
        
        const lines = text.trim().split('\n');
        let allQuestions = lines.map(line => {
            const [cat, q, a1, a2, a3, a4, hint] = line.split('\t');
            categoryName = cat; // TSVの1列目からカテゴリー名を取得
            return { text: q, options: [a1, a2, a3, a4], correct: a1, hint: hint };
        });

        // 1. 出題数バリデーション
        let count = inputCount;
        if (inputCount > allQuestions.length) {
            document.getElementById('error-msg').innerText = `※登録数(${allQuestions.length}問)を超えています。全問出題します。`;
            count = allQuestions.length;
        }

        // シャッフルして出題数を絞る
        quizData = allQuestions.sort(() => Math.random() - 0.5).slice(0, count);
        userAnswers = new Array(quizData.length).fill(null);
        
        document.getElementById('current-category').innerText = categoryName;
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        showQuestion();
    } catch (e) {
        alert("TSVファイルの読み込みに失敗しました。サーバー環境で実行してください。");
    }
}

function showQuestion() {
    const q = quizData[currentIdx];
    const state = userAnswers[currentIdx];

    document.getElementById('progress').innerText = `${currentIdx + 1} / ${quizData.length}`;
    document.getElementById('question-text').innerText = q.text;
    
    const container = document.getElementById('options-container');
    container.innerHTML = '';

    // 2. 選択肢シャッフル（初回のみ）
    if (!q.shuffledOptions) {
        q.shuffledOptions = [...q.options].sort(() => Math.random() - 0.5);
    }

    q.shuffledOptions.forEach((opt, index) => {
        const div = document.createElement('div');
        div.className = 'option';
        // A, B, C... のラベル付け
        const label = String.fromCharCode(65 + index); 
        div.innerText = `${label}. ${opt}`;
        
        // 8. 1度解答済みなら再解答不可
        if (state) {
            div.classList.add('disabled');
            if (opt === q.correct) div.classList.add('correct');
            if (opt === state.selected && opt !== q.correct) div.classList.add('wrong');
        } else {
            div.onclick = () => {
                userAnswers[currentIdx] = { selected: opt, isCorrect: (opt === q.correct) };
                showQuestion();
            };
        }
        container.appendChild(div);
    });

    // 3. 解答後に解説表示
    const expArea = document.getElementById('explanation-area');
    if (state) {
        expArea.classList.remove('hidden');
        expArea.innerText = q.hint;
    } else {
        expArea.classList.add('hidden');
    }
    
    document.getElementById('next-btn').innerText = (currentIdx === quizData.length - 1) ? "終了" : "次へ";
}

function nextQuestion() {
    if (currentIdx < quizData.length - 1) { currentIdx++; showQuestion(); }
    else { showResult(); }
}

function prevQuestion() {
    if (currentIdx > 0) { currentIdx--; showQuestion(); }
}

function showResult() {
    document.getElementById('quiz-screen').classList.add('hidden');
    document.getElementById('result-screen').classList.remove('hidden');
    
    const correctCount = userAnswers.filter(a => a && a.isCorrect).length;
    const rate = Math.round((correctCount / quizData.length) * 100);

    document.getElementById('result-percent').innerText = `${rate}%`;
    document.getElementById('result-ratio').innerText = `${correctCount} / ${quizData.length}`;
    
    const msg = document.getElementById('feedback-msg');
    // 5. 80%キープの喚起
    if (rate >= 80) {
        msg.innerText = "合格ライン突破です！";
        msg.style.color = "#2e7d32";
    } else {
        msg.innerText = "80%以上を目指して復習しましょう！";
        msg.style.color = "#d32f2f";
    }
}
</script>
</body>
</html>
